# Party Portal Flow

> Token-based self-service flow for party data collection.

## Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PARTY PORTAL FLOW                                │
│                                                                         │
│  INVITE ──► RECEIVE ──► OPEN ──► FILL ──► SUBMIT ──► CONFIRM           │
│    │          │          │        │         │          │                │
│    ▼          ▼          ▼        ▼         ▼          ▼                │
│  Token    Email      Validate   Auto-    Submit     Show               │
│  Created  Sent       Token      save     Data       Confirmation       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Link Generation

### Escrow Officer Action
Complete wizard collection phase and generate party links

### System Flow

```
Escrow officer clicks "Generate Party Links"
         │
         ▼
POST /reports/{id}/party-links
{
  "parties": [
    {
      "party_role": "transferee",
      "entity_type": "llc",
      "display_name": "ABC Holdings LLC"
    },
    {
      "party_role": "transferor",
      "entity_type": "individual",
      "display_name": "John Smith"
    }
  ],
  "expires_in_days": 14
}
         │
         ▼
For each party:
         │
         ├── Create ReportParty
         │   - id: UUID
         │   - report_id: {report_id}
         │   - party_role: "transferee"
         │   - entity_type: "llc"
         │   - display_name: "ABC Holdings LLC"
         │   - status: "link_sent"
         │   - party_data: {}
         │
         ├── Create PartyLink
         │   - id: UUID
         │   - report_party_id: {party_id}
         │   - token: generate_secure_token() // 64 chars
         │   - expires_at: now + 14 days
         │   - status: "active"
         │
         └── Create NotificationEvent
             - type: "party_invite"
             - to_email: (from wizard data)
             - subject: "Action Required: Submit Your Information"
             - body_preview: "..."
             - party_token: {token}
         │
         ▼
Return response:
{
  "report_id": "...",
  "links": [
    {
      "party_id": "...",
      "role": "transferee",
      "token": "abc123...",
      "link_url": "https://app.example.com/p/abc123...",
      "expires_at": "2026-02-24T00:00:00Z"
    }
  ]
}
```

### Token Security

```
Token: 64 characters
Generated by: secrets.token_urlsafe(48)
Example: "Xk3m9_pQ7rT2wY5uI8oP0aS4dF6gH1jK3lZ9xC2vB5nM0qW4eR7tY8uI1oP3aS6d"

Properties:
- Cryptographically random
- URL-safe (no encoding needed)
- Cannot be guessed or enumerated
- Unique per party link
```

---

## Phase 2: Party Access

### Party Action
Open link from email

### System Flow

```
Party opens https://app.example.com/p/{token}
         │
         ▼
Frontend loads page
         │
         ▼
GET /party/{token}
         │
         ▼
Validate token:
         │
         ├── Token exists? → No → 404 "Link not found"
         │
         ├── Status = "active"? → No → 404 "Link expired or used"
         │
         └── expires_at > now? → No → 404 "Link expired"
         │
         ▼
Return party data:
{
  "party_id": "...",
  "role": "transferee",
  "entity_type": "llc",
  "party_data": {},  // Empty or partially filled
  "status": "link_sent",
  "report_summary": {
    "property_address": "123 Main St, Los Angeles, CA 90001",
    "closing_date": "2026-02-15",
    "title_company": "Pacific Coast Title"
  },
  "is_submitted": false
}
         │
         ▼
Frontend renders form based on entity_type
```

### Form Rendering

| Entity Type | Form Sections |
|-------------|---------------|
| individual | Name, DOB, SSN, Address, Contact |
| llc | Entity Info, Beneficial Owners, Signing Individual |
| corporation | Entity Info, Beneficial Owners, Signing Individual |
| trust | Trust Info, Trustees, Settlors, Beneficiaries |

---

## Phase 3: Data Entry

### Party Action
Fill out form fields

### System Flow

```
Party types in form field
         │
         ▼
onChange handler updates local state
         │
         ▼
Debounce timer starts (1500ms)
         │
         ▼
Timer expires
         │
         ▼
POST /party/{token}/save
{
  "party_data": {
    "legal_name": "ABC Holdings LLC",
    "tin": "12-3456789",
    "address": {
      "street": "456 Business Ave",
      "city": "San Francisco",
      "state": "CA",
      "zip": "94102"
    },
    "beneficial_owners": [
      {
        "first_name": "John",
        "last_name": "Smith",
        "ownership_percentage": 60
      }
    ]
  }
}
         │
         ▼
Validate token (same checks)
         │
         ▼
Update ReportParty:
  - party_data = {submitted data}
  - status = "in_progress" (if was "link_sent")
  - updated_at = now
         │
         ▼
Return:
{
  "party_id": "...",
  "status": "in_progress",
  "updated_at": "..."
}
```

### Auto-Save Behavior

- Triggered after 1500ms of no changes
- Silent failure (no user notification on error)
- Retries automatically on next change
- Status changes to "in_progress" on first save

---

## Phase 4: Submission

### Party Action
Review and submit form

### System Flow

```
Party reviews all information
         │
         ▼
Party checks certification checkbox:
  ☑ "I certify that all information is accurate..."
         │
         ▼
Party clicks "Submit"
         │
         ▼
POST /party/{token}/submit
{
  "party_data": {
    // ... all form data ...
    "certification": {
      "agreed": true,
      "agreed_at": "2026-02-10T14:30:00Z"
    }
  }
}
         │
         ▼
Validate token (same checks)
         │
         ▼
Check not already submitted:
  link.status == "used"? → 409 "Already submitted"
         │
         ▼
Update records:
         │
         ├── ReportParty
         │   - party_data = {final data}
         │   - status = "submitted"
         │   - updated_at = now
         │
         ├── PartyLink
         │   - status = "used"
         │   - submitted_at = now
         │
         ├── NotificationEvent
         │   - type: "party_submitted"
         │   - to_email: {party email}
         │   - subject: "Submission Confirmed"
         │
         └── AuditLog
             - action: "party.submitted"
             - actor_type: "party"
             - ip_address: {client IP}
         │
         ▼
Return:
{
  "party_id": "...",
  "status": "submitted",
  "submitted_at": "2026-02-10T14:30:00Z",
  "confirmation_id": "PARTY-ABC12345",
  "message": "Thank you! Your information has been submitted."
}
```

---

## Phase 5: Confirmation

### UI Display

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    ✓ Thank You!                             │
│                                                             │
│     Your information has been submitted successfully.       │
│                                                             │
│     ┌─────────────────────────────────────────────┐         │
│     │ Confirmation ID                             │         │
│     │                                             │         │
│     │     PARTY-ABC12345                          │         │
│     └─────────────────────────────────────────────┘         │
│                                                             │
│     You may close this window. If you need to make          │
│     changes, please contact your title company.             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Error States

### Invalid Token

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    ⚠ Link Not Found                         │
│                                                             │
│     This link may have expired or already been used.        │
│                                                             │
│     Please contact your title company for a new link.       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Already Submitted

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    ✓ Already Submitted                      │
│                                                             │
│     Your information has already been submitted.            │
│                                                             │
│     Confirmation ID: PARTY-ABC12345                         │
│                                                             │
│     If you need to make changes, please contact             │
│     your title company.                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Status Transitions

```
link_sent ──► in_progress ──► submitted
     │              │              │
     │              │              └── Link: used
     │              │
     │              └── Party saves data
     │
     └── Party opens link
```

---

## Data Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ESCROW OFFICER                          PARTY                           │
│                                                                          │
│  ┌───────────────┐                      ┌───────────────┐                │
│  │    Wizard     │                      │   Browser     │                │
│  │  (Frontend)   │                      │               │                │
│  └───────┬───────┘                      └───────┬───────┘                │
│          │                                      │                        │
│          │ POST /reports/{id}/party-links       │                        │
│          ▼                                      │                        │
│  ┌───────────────┐                              │                        │
│  │     API       │ ─────────────────────────────│───────────────┐        │
│  │   (Backend)   │                              │               │        │
│  └───────┬───────┘                              │               │        │
│          │                                      │               │        │
│          │ Create records                       │               │        │
│          ▼                                      │               │        │
│  ┌───────────────┐                              │               │        │
│  │   Database    │                              │               │        │
│  │               │                              │               │        │
│  └───────────────┘                              │               │        │
│          │                                      │               │        │
│          │ NotificationEvent (email log)        │               │        │
│          ▼                                      │               │        │
│  ┌───────────────┐                              │               │        │
│  │  Email Outbox │ ─ (future: SendGrid) ────────│─► Email       │        │
│  │               │                              │               │        │
│  └───────────────┘                              │               │        │
│                                                 │               │        │
│                                                 │ GET /p/{token}│        │
│                                                 ▼               │        │
│                                         ┌───────────────┐       │        │
│                                         │   Portal UI   │       │        │
│                                         │               │       │        │
│                                         └───────┬───────┘       │        │
│                                                 │               │        │
│                                                 │ POST /party/{token}/submit
│                                                 ▼               │        │
│                                         ┌───────────────┐       │        │
│                                         │     API       │◄──────┘        │
│                                         │               │                │
│                                         └───────────────┘                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## Key Files

| Purpose | File |
|---------|------|
| Link generation | `api/app/routes/reports.py` → `create_party_links` |
| Token validation | `api/app/routes/parties.py` → `get_valid_link` |
| Portal UI | `web/app/p/[token]/page.tsx` |
| API client | `web/lib/api.ts` → `getParty`, `saveParty`, `submitParty` |
| Token model | `api/app/models/party_link.py` |
